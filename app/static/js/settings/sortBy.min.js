document.addEventListener("DOMContentLoaded", (() => {
  function T(key, fallback){
    const path = String(key||'').split('.');
    let obj = (window.I18N_WEB || {});
    for (const p of path){ if (obj && typeof obj === 'object' && p in obj) obj = obj[p]; else return fallback; }
    return (typeof obj === 'string') ? obj : fallback;
  }
  const ASC = T('settings.search.sort.asc','Crescente');
  const DESC = T('settings.search.sort.desc','Decrescente');
  const PREV_LABEL = T('settings.search.sort.preview','Ordenação: —');

  const e = document.getElementById("sortList"),
        t = document.getElementById("sortPreview");
  if (!e) return;

  new Sortable(e, {
    animation: 150,
    handle: ".handle",
    ghostClass: "sortable-ghost",
    chosenClass: "sortable-chosen",
    onSort: () => r()
  });

  const items = () => e.querySelectorAll(".sort-item");
  const tune = cb => {
    const lab = cb.closest(".form-switch").querySelector(".form-check-label");
    lab.textContent = cb.checked ? ASC : DESC; // checked => asc
    lab.classList.toggle("text-muted", cb.disabled);
  };

  const r = () => {
    const parts = [];
    items().forEach(li => {
      const en = li.querySelector(".js-sort-enable");
      const dir = li.querySelector(".js-sort-dir");
      const label = li.querySelector(`label[for="${en.id}"]`).textContent.trim();
      if (en.checked) parts.push(`${label} (${dir.checked ? ASC : DESC})`);
    });
    t.textContent = parts.length ? `${PREV_LABEL.replace('—','')} ${parts.join(" → ")}` : PREV_LABEL;
  };

  items().forEach(li => {
    const en  = li.querySelector(".js-sort-enable");
    const dir = li.querySelector(".js-sort-dir");
    dir.disabled = !en.checked;
    tune(dir);
    en.addEventListener("change", () => { dir.disabled = !en.checked; tune(dir); r(); });
    dir.addEventListener("change", () => { tune(dir); r(); });
  });

  r();

  window.getSortSpec = function() {
    const out = [];
    items().forEach(li => {
      const en  = li.querySelector(".js-sort-enable");
      const dir = li.querySelector(".js-sort-dir");
      if (en.checked) out.push({ field: en.dataset.key, direction: dir.checked ? "asc" : "desc" });
    });
    return out;
  }
}));
